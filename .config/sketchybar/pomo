#!/bin/bash

# Source common configuration
SCRIPT_DIR="$(dirname "$0")"
source "$SCRIPT_DIR/pomodoro_common.sh"

# Ensure directory exists
ensure_pomo_dir

# Function to add appropriate emoji to task name
add_emoji_to_task() {
    local task="$1"
    local first_word=$(echo "$task" | awk '{print $1}')
    
    # List of known emojis we use
    case "$first_word" in
        "🍅"|"☕️"|"🎓"|"📦"|"⚙️"|"🧘"|"🎮"|"📚"|*[![:ascii:]]*)
            # Already has emoji, return as-is
            echo "$task"
            ;;
        *)
            # No emoji, add one based on keywords
            local task_lower=$(echo "$task" | tr '[:upper:]' '[:lower:]')
            if [[ "$task_lower" == *"break"* ]]; then
                echo "☕️ $task"
            elif [[ "$task_lower" == *"technion"* ]]; then
                echo "🎓 $task"
            elif [[ "$task_lower" == *"logistics"* ]]; then
                echo "📦 $task"
            elif [[ "$task_lower" == *"dotfiles"* ]]; then
                echo "⚙️ $task"
            elif [[ "$task_lower" == *"therapy"* ]]; then
                echo "🧘 $task"
            else
                echo "🍅 $task"  # Default tomato
            fi
            ;;
    esac
}

# Initialize files with defaults if they don't exist
[ ! -f "$TITLE_FILE" ] && echo "$DEFAULT_TASK" > "$TITLE_FILE"
[ ! -f "$WORK_TIME_FILE" ] && echo "$DEFAULT_WORK_TIME" > "$WORK_TIME_FILE"
[ ! -f "$BREAK_TIME_FILE" ] && echo "$DEFAULT_BREAK_TIME" > "$BREAK_TIME_FILE"

# Interactive mode if no arguments
if [ $# -eq 0 ]; then
    echo "🍅 Pomodoro Timer Configuration"
    echo "=============================="
    echo ""
    
    # Show current settings
    CURRENT_TASK=$(cat "$TITLE_FILE")
    CURRENT_WORK=$(cat "$WORK_TIME_FILE")
    CURRENT_BREAK=$(cat "$BREAK_TIME_FILE")
    CURRENT_DEBUG=$(is_debug_mode && echo "enabled" || echo "disabled")
    
    echo "Current settings:"
    echo "  📝 Task: $CURRENT_TASK"
    echo "  🍅 Work time: $CURRENT_WORK minutes"
    echo "  ☕️ Break time: $CURRENT_BREAK minutes"
    echo "  🐛 Debug mode: $CURRENT_DEBUG"
    echo ""
    
    # Quick presets
    echo "Quick presets:"
    echo "  1) Standard (25/5)"
    echo "  2) Long focus (50/10)"
    echo "  3) Short burst (15/3)"
    echo "  4) Custom"
    echo ""
    echo -n "Choose preset (1-4) or press Enter for custom: "
    read PRESET
    
    case "$PRESET" in
        1)
            NEW_WORK_TIME="25"
            NEW_BREAK_TIME="5"
            echo "Using Standard preset (25/5)"
            ;;
        2)
            NEW_WORK_TIME="50"
            NEW_BREAK_TIME="10"
            echo "Using Long focus preset (50/10)"
            ;;
        3)
            NEW_WORK_TIME="15"
            NEW_BREAK_TIME="3"
            echo "Using Short burst preset (15/3)"
            ;;
        *)
            echo ""
            echo -n "Enter work time in minutes (or press Enter for $CURRENT_WORK): "
            read NEW_WORK_TIME
            
            echo -n "Enter break time in minutes (or press Enter for $CURRENT_BREAK): "
            read NEW_BREAK_TIME
            ;;
    esac
    
    echo ""
    echo -n "Enter task name (or press Enter to keep current): "
    read NEW_TITLE
    
    echo -n "Enable debug mode? (y/N): "
    read DEBUG_RESPONSE
    
    # Apply changes
    if [ -n "$NEW_TITLE" ]; then
        NEW_TITLE=$(add_emoji_to_task "$NEW_TITLE")
        echo "$NEW_TITLE" > "$TITLE_FILE"
    fi
    [ -n "$NEW_WORK_TIME" ] && echo "$NEW_WORK_TIME" > "$WORK_TIME_FILE"
    [ -n "$NEW_BREAK_TIME" ] && echo "$NEW_BREAK_TIME" > "$BREAK_TIME_FILE"
    
    if [[ "$DEBUG_RESPONSE" =~ ^[Yy]$ ]]; then
        touch "$DEBUG_FILE"
    elif [[ "$DEBUG_RESPONSE" =~ ^[Nn]$ ]]; then
        rm -f "$DEBUG_FILE"
    fi
    
    echo ""
    echo "Settings updated!"
    echo ""
    echo "Final settings:"
    echo "  Task: $(cat "$TITLE_FILE")"
    echo "  Work time: $(cat "$WORK_TIME_FILE") minutes"
    echo "  Break time: $(cat "$BREAK_TIME_FILE") minutes"
    echo "  Debug mode: $(is_debug_mode && echo "enabled" || echo "disabled")"
    exit 0
fi

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -n|--name)
            TITLE="$2"
            shift 2
            ;;
        --wt|--work-time)
            WORK_TIME="$2"
            shift 2
            ;;
        --bt|--break-time)
            BREAK_TIME="$2"
            shift 2
            ;;
        --debug)
            DEBUG="1"
            shift
            ;;
        -h|--help)
            echo "Usage: pomo [options]"
            echo "Options:"
            echo "  -n, --name NAME          Set the task name/title"
            echo "  --wt, --work-time MINS   Set work session duration in minutes"
            echo "  --bt, --break-time MINS  Set break session duration in minutes"
            echo "  --debug                  Enable debug mode (1 second timers)"
            echo "  -h, --help               Show this help message"
            echo ""
            echo "Current settings:"
            echo "  Task: $(cat "$TITLE_FILE")"
            echo "  Work time: $(cat "$WORK_TIME_FILE") minutes"
            echo "  Break time: $(cat "$BREAK_TIME_FILE") minutes"
            echo "  Debug mode: $(is_debug_mode && echo "enabled" || echo "disabled")"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use 'pomo --help' for usage information"
            exit 1
            ;;
    esac
done

# Update files if values were provided
if [ -n "$TITLE" ]; then
    # Ensure all tasks have an icon prefix
    # This centralizes icon logic here instead of in pomodoro.sh
    TITLE=$(add_emoji_to_task "$TITLE")
    echo "$TITLE" > "$TITLE_FILE"
fi
[ -n "$WORK_TIME" ] && echo "$WORK_TIME" > "$WORK_TIME_FILE"
[ -n "$BREAK_TIME" ] && echo "$BREAK_TIME" > "$BREAK_TIME_FILE"
if [ -n "$DEBUG" ]; then
    if [ "$DEBUG" = "1" ]; then
        touch "$DEBUG_FILE"
    else
        rm -f "$DEBUG_FILE"
    fi
fi

# Show current settings
echo "Pomodoro settings updated:"
echo "  Task: $(cat "$TITLE_FILE")"
echo "  Work time: $(cat "$WORK_TIME_FILE") minutes"
echo "  Break time: $(cat "$BREAK_TIME_FILE") minutes"
echo "  Debug mode: $(is_debug_mode && echo "enabled" || echo "disabled")"